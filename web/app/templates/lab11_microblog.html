<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <link rel="stylesheet" href="static/css/open-iconic-bootstrap.css">
  <link rel="stylesheet" href="static/css/lab11twitter.css">
  <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>
  <!-- delete icon -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href='https://css.gg/backspace.css' rel='stylesheet'>

  <!-- edid icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>My Twitter</title>
</head>

<body>
  <nav class="navbar navbar-expand-md navbar-light">
    <div class="container">
      <div class="navbar-nav">
        <a class="nav-item nav-link" href="#"><span class="oi oi-home"></span> Home</a>
        <a class="nav-item nav-link" href="#"><span class="oi oi-bolt"></span> Moments</a>
        <a class="nav-item nav-link" href="#"><span class="oi oi-bell"></span> Notifications</a>
        <a class="nav-item nav-link" href="#"><span class="oi oi-envelope-open"></span> Messages</a>
      </div>
      <form class="form-inline">
        <input class="form-control" id="nav-search" type="search" placeholder="Search Twitter"> &nbsp;
        <img class="tw-user-small rounded-circle" src={{ current_user.avatar_url }}> &nbsp;
        <button class="btn" id="nav-tweet-btn" type="submit">Tweet</button>
        {% if not current_user.is_authenticated %}
          <button class="btn" id="logout" type="button">Login</button>
        {%else %}
          <button class="btn" id="logout" type="button">Logout</button>
          {%endif%}
      </form>
    </div>
  </nav>

  <div class="container">
    <div class="row">
      <div id="left_3" class="col-md-3">
        <div class="content-box">Account details</div>
        <div class="content-box">Trends</div>
      </div>
      <div id="center_6" class="col-md-6">
        <div class="content-box">
          <div class="new-tweet-row">
            <div class="new-tweet-row">
              {% if current_user.is_authenticated %}
              <div class="row">
                <div class="col-md-2">
                  <img src={{ current_user.avatar_url }} class="tw-user-small rounded-circle mx-auto d-block">
                </div>
                <div class="col-md-9">
                  <form id="addPhoneNumberForm">
                    <!-- <div class="inputbox">
                      <input type="input" id="name" name="name" placeholder="Your name.." required>
                    </div>
                    <div class="inputbox">
                      <input type="email" id="email" name="email" placeholder="email" required>
                    </div> -->
                    <input type="hidden" id="user-name" value="{{ current_user.name }}">
                    <input type="hidden" id="user-email" value="{{ current_user.email }}">
                    <input type="hidden" id="user-avatar" value="{{ current_user.avatar_url }}">
                    <div class="inputbox">
                      <textarea id="messagebox" name="message" placeholder="What's happening" required></textarea>
                    </div>
                    <input type="hidden" id="entryid" name="id" value=""><br>
                    <div class="inputbox">
                    <input type="submit" name="submit" value="Post">
                    </div>
                  </form>
                </div>
              </div>
              {% endif %}
            </div>
            <div id="BoxMessages">

            </div>
          </div>
        </div>

      </div>

      <div id="right_3" class="col-md-3">
        <div class="content-box">Who to follow</div>
      </div>
    </div>
    <!-- Optional JavaScript-->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"></script> -->
    <script>

      function populate_table(contact_data) {

        for (var i = contact_data.length - 1; i >= 0; i--) {

          var elamant = document.getElementById("BoxMessages");
          var Boxshow = `<div class="tweet"
            data-id="${contact_data[i].id}">
            
              
              <div class="row">
                <div class="col-md-2 text-center">
                  <img class="tw-user-medium rounded-circle" src=${contact_data[i].avatar_url}>
                </div>
                <div class="col-md-10">
                  <div class="row tweet-info">
                    <div class="col-md-auto">
                      <span class="tweet-username" id="checkname${i}">${contact_data[i].name}</span>
                      <span class="tweet-usertag text-muted" id="checkemail${i}">${contact_data[i].email}</span>
                      <div class="tweet-text">
                    ${contact_data[i].date_Created}<br>
                    ${contact_data[i].date_Update}
                  </div>
                    
                    </div>
                    
                  </div>
                  <div class="tweet-text">
                    ${contact_data[i].message}

                  </div>
        
                  <div class="tweet-media">
                    <textarea type="input" id="popup${contact_data[i].id}" name="updatemessage${contact_data[i].id}" style="display:none" placeholder="message" required></textarea><br>
                    <input type="submit" id="save${contact_data[i].id}" onclick="getid(${contact_data[i].id})" style="visibility:hidden" value="Save">
            
                  </div>

                  <div class="row text-muted">
                    <div class="col-md-2"><span class="oi oi-bullhorn"></span></div>
                    <div class="col-md-2"><span class="oi oi-loop-circular"></span></div>
                    <div class="col-md-2"><span class="oi oi-heart"></span></div>
                    <div class="col-md-2"><span class="oi oi-envelope-open"></span></div>
                    <div class="col-md-2"><i class="fa fa-trash" id="check${i}" onclick="removeItem(${contact_data[i].id})"></i> </div>
                    <div class="col-md-2"><i class="fa fa-edit" id="checkk${i}" onclick="editItem(${contact_data[i].id})"></i> </div>
                    
                  </div>
                </div>
              </div>
            </div>`;

          $("#BoxMessages").append((Boxshow));
          if ($("#checkname" + i).html()===$("#user-name").val() && $("#checkemail" + i).html()===$("#user-email").val()){}
          else{
            $("#check" + i).hide();
            $("#checkk" + i).hide();
          }
        }
      }

      $(document).ready(function () {
        (function () {
          $.getJSON("lab11/contacts", populate_table);
        })();
      });

      function refresh_table(contact_data) {
        $('#BoxMessages').empty();
        populate_table(contact_data);
      }

      function removeItem(row) {
        if (!confirm("Delete " + '?')) {
          return false;
        }
        var url = "lab11/remove_contact"
        var formData = { 'id': row };
        $.post(url, formData, function (contact_data) {
          refresh_table(contact_data);
        });
      }

      function getid(i) {
        console.log(i)
        $(document).on('click', '#save' + i, function () {
          var new_message = document.getElementById("popup" + i).value;
          console.log(new_message);
          // console.log(id);
          $.ajax({
            type: 'POST',
            url: '/lab11/edit',
            data: { id: i, message: new_message, date_Update: thailandLocalDate() },
            success: function (response) {
              $.getJSON("lab11/contacts", function (data) {
                refresh_table(data);
              });
            }
          });

        });
      }

      function editItem(row) {
        if (!confirm("Edit Now " + '?')) {
          return false;
        }
        var popup = document.getElementById("popup" + row)
        popup.style.display = "block"
        var saveup = document.getElementById("save" + row)
        saveup.style.visibility = "visible"

      }
// funsion add post
      $("#addPhoneNumberForm").submit(function (event) {
        // prevent default html form submission action
        event.preventDefault();


        // pack the inputs into a dictionary
        var formData = {};
        $(":input").each(function () {
          var key = $(this).attr('name');
          var val = $(this).val();


          if (key != 'submit') {
            formData[key] = val;
          }
        });
        formData["name"] = $('#user-name').val();
        formData["email"] = $('#user-email').val();
        formData["date_Created"] = thailandLocalDate();
        formData["date_Update"] = thailandLocalDate();
        formData["avatar_url"] = $('#user-avatar').val();
        var $form = $(this);
        var url = $form.attr("action");


        // make a POST call to the back end w/ a callback to refresh the table
        $.post(url, formData, function (contact_data) {
          refresh_table(contact_data);
          $('input[name=name]').val('');
          $('input[name=email]').val('');
          $('textarea[name=message]').val('');
        });
      });

      function thailandLocalDate() {
        var date = new Date();
        var offset = date.getTimezoneOffset();
        var thailandTime = new Date(date.getTime() + (420 + offset) * 60 * 1000);
        var thailandTimeString = thailandTime.toLocaleString();
        return thailandTimeString;
      }
      $("#logout").click(function () {
     window.location.href = "lab13/logout";
   });
    </script>
</body>

</html>